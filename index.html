<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Document</title>
  <script src="/socket.io/socket.io.js"></script>
  <script src="http://cdn.peerjs.com/0.3/peer.js"></script>
<script>
navigator.webkitGetUserMedia({audio:true}, function(stream) {
  var peer
  var socket = io()
  // `peer-server`へ自分のstreamを公開する
  socket.on('connect',function(){
    var options= {
      host: location.hostname,
      port: location.port,
      path: 'api',
    }
    peer = new Peer(socket.id, options)
    peer.on('call', function(call) {
      console.log(call.peer+'にcallされました')
      call.answer(stream)
    })
  })
  // 公開されているstreamをaudio要素に全て変換する
  socket.on('keys',function(keys){
    var audios= document.querySelector('#audios')
    audios.innerHTML= ''

    var index= keys.indexOf(socket.id)
    if(index>-1){
      keys.splice(index,1)
    }

    keys.forEach(function(key){
      var call = peer.call(key, stream);
      if(call===undefined){
        console.log(key+'なんて居ません')
        return
      }

      call.on('stream', function(remoteStream) {
        var audio= new Audio
        audio.src= URL.createObjectURL(remoteStream)
        audio.controls= true
        audio.play()

        audios.appendChild(audio)
      });
    })
  })

}, function(error) {
  alert('Failed to get local stream' ,error);
});
</script>
  
</head>
<body>

<section id="audios">
  <p>他のユーザーを待っています…</p>
</section>
  
</body>
</html>